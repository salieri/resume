name: Deploy Release

permissions:
  contents: read
  deployments: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to deploy (e.g., `v1.2.3`)'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag }}

      - name: Read tool versions from package.json
        id: versions
        run: |
          NODE_VERSION=$(jq -r '.engines.node' package.json | sed 's/^[^0-9]*//')
          echo "node_version=$NODE_VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup PNPM
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.versions.outputs.node_version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace
        working-directory: dev/apps/resume
        run: pnpm --workspace-root build

      - name: Create GitHub deployment
        id: deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            -f ref="${{ inputs.tag }}" \
            -f environment="production" \
            -f description="Resume deployment ${{ inputs.tag }}" \
            -F auto_merge=false \
            --jq '.id')
          echo "id=$DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Deploy to Cloudflare Pages
        working-directory: dev/apps/resume
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_WRANGLER }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ] || [ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]; then
            echo "Cloudflare credentials are required for deployment." >&2
            exit 1
          fi
          pnpm dlx wrangler pages deploy ./dist/client --project-name resume --branch main

      - name: Mark deployment success
        if: steps.deployment.outputs.id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/deployments/${{ steps.deployment.outputs.id }}/statuses \
            -f state=success \
            -f description="Deployment completed via Cloudflare Pages"
